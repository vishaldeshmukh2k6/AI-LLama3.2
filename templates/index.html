<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>OLLama Assistant</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs/themes/prism.css">
<script src="https://cdn.jsdelivr.net/npm/prismjs/prism.js"></script>
<style>
  :root{
    --bg:#343541; --panel:#444654; --panel-alt:#40414f; --border:#2f3036; --border-2:#565869;
    --fg:#e5e7eb; --fg-dim:#cbd5e1; --brand:#10b981; --brand-2:#059669; --user:#7c3aed;
    --maxw:820px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
  a{color:inherit}
  .hidden{display:none}

  .topbar{position:sticky;top:0;z-index:10;background:rgba(52,53,65,.9);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
  .topbar-inner{max-width:var(--maxw);width:var(--maxw);margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
  .title{font-weight:600}
  .top-actions{display:flex;gap:8px;align-items:center}
  .badge{font-size:12px;color:var(--fg-dim)}
  .btn{cursor:pointer;border-radius:6px;border:1px solid var(--border-2);background:var(--panel);color:var(--fg);padding:6px 10px;font-size:12px}
  .btn:hover{background:#4a4c54}
  .btn-primary{background:var(--brand);border-color:var(--brand-2)}
  .btn-primary:hover{background:var(--brand-2)}

  .container{max-width:var(--maxw);width:var(--maxw);margin:0 auto;padding:0 12px 140px}
  /* Make chat box fixed-size, scrollable, and visually separated */
  .chat{margin-top:12px;height:calc(100vh - 200px);overflow:auto;border:1px solid var(--border);border-radius:12px;background:var(--panel-alt)}

  .row{width:100%}
  .wrap{position:relative;display:flex;gap:12px;padding:12px}
  .wrap.assistant{flex-direction:row;justify-content:flex-start}
  .wrap.user{flex-direction:row;justify-content:flex-start}
  .avatar{flex:0 0 32px;width:32px;height:32px;border-radius:50%;background:var(--brand);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px}
  .avatar.user{background:var(--user)}
  .bubble{max-width:76%;border:1px solid var(--border-2);border-radius:12px;padding:10px 12px}
  .bubble.assistant{background:var(--panel)}
  .bubble.user{background:var(--panel-alt);padding:6px 10px;line-height:1.35}
  .bubble :is(h1,h2,h3){margin:12px 0 6px}
  .bubble pre{position:relative;overflow:auto;border:1px solid var(--border-2);background:#2d2f39;border-radius:8px;padding:12px}
  .copy-btn{position:absolute;top:6px;right:6px;background:#2d2f39;border:1px solid var(--border-2);color:#ddd;padding:2px 6px;border-radius:4px;font-size:11px}
  .copy-btn:hover{background:#3a3d48}

  .composer{position:fixed;left:0;right:0;bottom:0;border-top:1px solid var(--border);background:linear-gradient(to top, var(--bg), rgba(52,53,65,.95), transparent)}
  .composer-inner{max-width:var(--maxw);width:var(--maxw);margin:0 auto;padding:12px 16px}
  .attachbar{font-size:11px;color:var(--fg-dim);margin-bottom:6px;min-height:16px}
  .bar{display:flex;gap:8px;align-items:flex-end}
  .attach{cursor:pointer;border-radius:6px;border:1px solid var(--border-2);background:var(--panel);height:44px;min-width:88px;padding:0 12px;font-size:14px;display:flex;align-items:center;justify-content:center}
  .input{flex:1;max-height:120px;min-height:44px;background:var(--panel-alt);border:1px solid var(--border-2);border-radius:8px;color:var(--fg);padding:10px;resize:none;overflow:auto}
  .toggle{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--fg-dim);border-radius:6px;border:1px solid var(--border-2);background:var(--panel);padding:8px 10px;height:44px}
  .send{border:none;height:44px;min-width:88px;font-weight:600}
  .tip{font-size:10px;color:#9aa3b2;margin-top:6px}

  .mt-8{margin-top:8px}
</style>
</head>
<body>

<header class="topbar">
  <div class="topbar-inner">
    <div class="title">OLLama Assistant</div>
    <div class="top-actions">
      <button id="clearBtn" class="btn">Clear</button>
      <div class="badge">Llama 3.2 1B • English only</div>
    </div>
  </div>
</header>

<main class="container">
  <div id="chat" class="chat"></div>
</main>

<!-- Removed scroll-to-bottom button -->

<div class="composer">
  <div class="composer-inner">
    <div id="attachBar" class="attachbar"></div>
    <div class="bar">
      <label class="attach" title="Attach files">+
        <input type="file" id="attachments" multiple accept=".txt,.md,.pdf" style="display:none;">
      </label>
      <textarea id="questionInput" rows="1" placeholder="Ask anything" class="input"></textarea>
      <label class="toggle"><input type="checkbox" id="realtimeToggle"> Realtime</label>
      <button onclick="askAIStream()" class="btn btn-primary send">Send</button>
    </div>
    <div class="tip">Tip: Use Realtime for fresh web info with citations. Attach files per‑message when needed.</div>
  </div>
</div>

<script>
function addMessage(role, html){
  const chat = document.getElementById('chat');
  const row = document.createElement('div');
  row.className = 'row';

  const wrap = document.createElement('div');
  wrap.className = 'wrap ' + role;

  const avatar = document.createElement('div');
  avatar.className = 'avatar ' + role;
  avatar.textContent = role==='assistant' ? 'AI' : 'U';

  const bubble = document.createElement('div');
  bubble.className = 'bubble ' + role;
  bubble.innerHTML = html;

  const copyMsgBtn = document.createElement('button');
  copyMsgBtn.className = 'copy-btn';
  copyMsgBtn.textContent = 'Copy';
  copyMsgBtn.onclick = () => copyText(stripHtml(bubble.innerHTML));
  bubble.appendChild(copyMsgBtn);

  wrap.appendChild(avatar);
  wrap.appendChild(bubble);
  row.appendChild(wrap);
  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;
  enhanceCodeBlocks(bubble);
  return bubble;
}

function stripHtml(html){
  const tmp = document.createElement('div'); tmp.innerHTML = html; return tmp.textContent || tmp.innerText || '';
}

function enhanceCodeBlocks(container){
  const blocks = container.querySelectorAll('pre');
  blocks.forEach(pre => {
    if(pre.querySelector('.copy-btn')) return;
    const btn = document.createElement('button');
    btn.className = 'copy-btn';
    btn.textContent = 'Copy';
    btn.onclick = () => copyText(pre.innerText);
    pre.appendChild(btn);
  });
}

async function copyText(text){
  try{ await navigator.clipboard.writeText(text); }catch(e){ console.warn(e); }
}

function listAttachments(){
  const files = Array.from(document.getElementById('attachments').files||[]);
  document.getElementById('attachBar').innerText = files.length ? files.map(f=>f.name).join(', ') : '';
}

document.getElementById('attachments').addEventListener('change', listAttachments);

document.getElementById('questionInput').addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); askAIStream(); }
});

document.getElementById('clearBtn').addEventListener('click', ()=>{
  document.getElementById('chat').innerHTML = '';
});

// Removed scroll button logic

async function askAIStream(){
  const input = document.getElementById('questionInput');
  const q = input.value.trim();
  if(!q) return;

  addMessage('user', marked.parse(q));
  input.value = '';

  const assistantBubble = addMessage('assistant', '<div class="dot-flashing"></div>');

  const files = Array.from(document.getElementById('attachments').files||[]);
  const realtime = document.getElementById('realtimeToggle').checked;
  let resp;
  if(files.length){
    const fd = new FormData();
    fd.append('question', q);
    fd.append('realtime', realtime ? '1' : '0');
    for(const f of files){ fd.append('files', f); }
    resp = await fetch('/ask_stream', { method:'POST', body: fd });
  } else {
    resp = await fetch('/ask_stream', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({question:q, realtime}) });
  }

  const reader = resp.body.getReader();
  const decoder = new TextDecoder();
  let fullAnswer = '';
  while(true){
    const {value, done} = await reader.read();
    if(done) break;
    const chunk = decoder.decode(value);
    const lines = chunk.split('\n').filter(line => line.startsWith('data:'));
    for(const line of lines){
      try{
        const obj = JSON.parse(line.slice(5));
        if(obj.answer){
          fullAnswer += obj.answer;
          assistantBubble.innerHTML = marked.parse(fullAnswer);
          Prism.highlightAll();
          enhanceCodeBlocks(assistantBubble);
        }
      }catch(e){ console.error(e); }
    }
  }

  try{
    const r = await fetch('/suggest', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({answer: fullAnswer}) });
    const d = await r.json();
    if(d.suggestions && d.suggestions.length){
      const sugBar = document.createElement('div');
      sugBar.className = 'mt-8';
      d.suggestions.forEach(s => {
        const b = document.createElement('button');
        b.className = 'btn';
        b.textContent = s;
        b.onclick = ()=>{ document.getElementById('questionInput').value = s; askAIStream(); };
        sugBar.appendChild(b);
      });
      assistantBubble.appendChild(sugBar);
    }
  }catch{}

  document.getElementById('attachments').value = '';
  listAttachments();
}

async function ingest(){
  const files = Array.from(document.getElementById('ingestFiles')?.files||[]);
  if(!files.length){ return; }
  const fd = new FormData();
  for(const f of files){ fd.append('files', f); }
  await fetch('/ingest', { method:'POST', body: fd });
}
</script>
</body>
</html>
