<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' }</script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-3xl bg-gray-800 rounded-2xl shadow-xl p-6 space-y-6">
    <div class="flex justify-between items-center">
      <h1 class="text-2xl font-semibold">Local AI Assistant</h1>
      <div id="indexInfo" class="text-sm text-gray-300">Index: 0 chunks</div>
    </div>

    <div class="grid grid-cols-1 gap-4">
      <!-- Upload card -->
      <div class="bg-gray-700 p-4 rounded-lg">
        <label class="block text-sm font-medium mb-2">Upload file (txt / md / pdf)</label>
        <div class="flex gap-3">
          <input id="fileInput" type="file" class="flex-1 text-sm text-gray-200 file:py-2 file:px-4 file:rounded-full file:bg-blue-600 file:text-white" />
          <button onclick="uploadFile()" class="bg-green-600 px-4 py-2 rounded-md hover:bg-green-700">Upload</button>
        </div>
        <p id="uploadStatus" class="mt-2 text-sm text-gray-300"></p>
      </div>

      <!-- Ask card -->
      <div class="bg-gray-700 p-4 rounded-lg">
        <label class="block text-sm font-medium mb-2">Ask anything</label>
        <textarea id="questionInput" rows="4" class="w-full p-3 bg-gray-800 rounded-md text-white border border-gray-600" placeholder="Type question..."></textarea>
        <div class="flex gap-3 mt-3 items-center">
          <button onclick="askAI()" class="bg-blue-600 px-4 py-2 rounded-md hover:bg-blue-700">Ask AI</button>
          <button onclick="clearUI()" class="bg-gray-600 px-4 py-2 rounded-md hover:bg-gray-500">Clear</button>
          <button id="startRecBtn" class="bg-purple-600 px-4 py-2 rounded-md hover:bg-purple-700">Speak</button>
        </div>
      </div>

      <!-- Response -->
      <div class="bg-gray-700 p-4 rounded-lg min-h-[120px]">
        <div id="responseBox" class="prose prose-invert text-gray-200 whitespace-pre-wrap"></div>
      </div>
    </div>
  </div>

<script>
async function refreshIndexInfo(){
  try{
    const r = await fetch('/index_info');
    if(r.ok){
      const d = await r.json();
      document.getElementById('indexInfo').innerText = `Index: ${d.chunks} chunks`;
    }
  }catch(e){}
}
refreshIndexInfo();

async function uploadFile(){
  const fi = document.getElementById('fileInput');
  if(!fi.files.length) return alert('Select a file first');
  const fd = new FormData();
  fd.append('file', fi.files[0]);
  document.getElementById('uploadStatus').innerText = 'Uploading...';
  try{
    const res = await fetch('/upload', { method: 'POST', body: fd });
    const data = await res.json();
    if(data.success){
      document.getElementById('uploadStatus').innerText = ` ${data.filename} (added ${data.added_chunks} chunks)`;
      refreshIndexInfo();
    } else {
      document.getElementById('uploadStatus').innerText = ` ${data.error || 'upload failed'}`;
    }
  }catch(err){
    document.getElementById('uploadStatus').innerText = ' Upload error: ' + err.message;
  }
}

function clearUI(){
  document.getElementById('questionInput').value = '';
  document.getElementById('responseBox').innerHTML = '';
}

async function askAI(){
  const q = document.getElementById('questionInput').value.trim();
  if(!q) return alert('Type a question');
  document.getElementById('responseBox').innerText = 'Thinking...';
  try{
    const res = await fetch('/ask', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ question: q })
    });
    const data = await res.json();
    if(data.answer) {
      document.getElementById('responseBox').innerText = data.answer;
      speakResponse(data.answer);
    } else if (data.error) {
      document.getElementById('responseBox').innerText = 'Error: ' + (data.error || JSON.stringify(data));
    } else {
      document.getElementById('responseBox').innerText = 'No response';
    }
  }catch(err){
    document.getElementById('responseBox').innerText = 'Request failed: ' + err.message;
  }
}

// Voice recognition integration with improved error handling & toggle button text
const startRecBtn = document.getElementById('startRecBtn');
const questionInput = document.getElementById('questionInput');

let recognition = null;
let isRecording = false;

startRecBtn.onclick = () => {
  if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
    alert('Your browser does not support speech recognition. Please type your question.');
    return;
  }

  if (isRecording) {
    recognition.stop();
    return;
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'en-IN';  // Hindi + English (Hinglish)
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.onstart = () => {
    isRecording = true;
    startRecBtn.innerText = 'Stop';
  };

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    questionInput.value = transcript;
  };

  recognition.onerror = (event) => {
    let msg = event.error === 'network' 
      ? 'Network error: Please check your internet connection and try again.'
      : `Speech recognition error: ${event.error}`;
    alert(msg);
    stopRecognition();
  };

  recognition.onend = () => {
    stopRecognition();
  };

  function stopRecognition() {
    isRecording = false;
    startRecBtn.innerText = 'Speak';
  }

  recognition.start();
};

// Text-to-Speech to speak AI response
function speakResponse(text) {
  if (!('speechSynthesis' in window)) {
    // No TTS support
    return;
  }
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'en-US'; // Change to 'en-IN' if you want Indian accent
  speechSynthesis.speak(utterance);
}

// Greet user on page load with voice message
window.onload = () => {
  const greeting = "Hi, how can I help you today?";
  document.getElementById('responseBox').innerText = greeting;
  speakResponse(greeting);
};
</script>
</body>
</html>
